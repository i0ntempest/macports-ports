# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           python 1.0

name                py-tensorflow-macos
version             2.18.0
revision            0

categories-append   lang
license             Apache-2
maintainers         nomaintainer
supported_archs     arm64 x86_64

description         Mac-optimized TensorFlow to be used with py-tensorflow-metal.

long_description    Hardware-accelerated TensorFlow and TensorFlow \
                    Addons for macOS 12.0+. Native hardware \
                    acceleration is supported on M1 Macs and \
                    Intel-based Macs through Appleâ€™s ML Compute \
                    framework.

homepage            https://developer.apple.com/metal/tensorflow-plugin/

extract.suffix      .whl
extract.only

# set build_arch by hand on arm64/x86_64 systems to get x86_64/arm64 checksums
# sudo port -d checksum py310-tensorflow-macos os.arch=arm build_arch=arm64
# run `port clean --all py*-tensorflow-macos` afterwards

python.versions     39 310 311 312
python.pep517       yes
python.pep517_backend

if {${build_arch} eq {arm64}} {
    set minimum_supported_major_version 21
} else {
    set minimum_supported_major_version 19
}
if {${os.arch} ni [list arm i386]
    || ${os.platform} eq {darwin}
        && ${os.major} < ${minimum_supported_major_version}} {
    known_fail      yes
    pre-fetch {
        ui_error "TensorFlow with ML Compute acceleration is only available \
            on macOS [expr ${minimum_supported_major_version} - 9] and later \
            with ${build_arch} architecture."
        error {unsupported platform}
    }
}

if {${name} ne ${subport}} {
    conflicts       py${python.version}-tensorflow \
                    py${python.version}-tensorflow1 \
                    py${python.version}-tensorflow-addons

    # https://pypi.org/project/tensorflow-macos/#files
    if {${build_arch} eq {arm64}} {
        distname tensorflow-${version}-cp${python.version}-cp${python.version}-macosx_12_0_${build_arch}
        if {${python.version} eq 312} {
            master_sites \
                    https://files.pythonhosted.org/packages/dc/bf/4cc283db323fd723f630e2454b2857054d2c81ff5012c1857659e72470f1/
            checksums \
                    rmd160  ecd768a4d5dbe42561d05c8afe22b8b71ed8d24b \
                    sha256  ec4133a215c59314e929e7cbe914579d3afbc7874d9fa924873ee633fe4f71d0 \
                    size    239565465
        } elseif {${python.version} eq 311} {
            master_sites \
                    https://files.pythonhosted.org/packages/26/08/556c4159675c1a30e077ec2a942eeeb81b457cc35c247a5b4a59a1274f05/
            checksums \
                    rmd160  d0735f8932a753e9b5969f59e5c568feeb7e9be4 \
                    sha256  453cb60638a02fd26316fb36c8cbcf1569d33671f17c658ca0cf2b4626f851e7 \
                    size    239492146
        } elseif {${python.version} eq 310} {
            master_sites \
                    https://files.pythonhosted.org/packages/0c/e8/d5d54e18ff6fe67c75c3c65415c98ecd31bd0ff7613d47a1390f062993b5/
            checksums \
                    rmd160  9eebe718469f93c43884506ebc05c1c1dee1edfc \
                    sha256  8da90a9388a1f6dd00d626590d2b5810faffbb3e7367f9783d80efff882340ee \
                    size    239373575
        } elseif {${python.version} eq 39} {
            master_sites \
                    https://files.pythonhosted.org/packages/25/31/52443f47e743d53ba1c9e8324e1a2eb0527df01d96d9174868c698b00d75/
            checksums \
                    rmd160  c0080baffef6e916827d0f95df9c1b9fc115cb90 \
                    sha256  336cace378c129c20fee6292f6a541165073d153a9a4c9cf4f14478a81895776 \
                    size    239375479
        }
    } elseif {${build_arch} eq {x86_64}} {
        version     2.16.2
        distname tensorflow-${version}-cp${python.version}-cp${python.version}-macosx_10_15_${build_arch}
        if {${python.version} eq 312} {
            master_sites \
                    https://files.pythonhosted.org/packages/eb/ba/1bf6837421d2cd8866866a296eb0b147f2a989951e3641e347c026584af0/
            checksums \
                    rmd160  5355df3c2adff187f59f1c86ad3bf69bcb5f2dbb \
                    sha256  912b8cd1f88fd1ef32b8db54f0193ad0a3f057691324436ba82c5f74a63a17dd \
                    size    259727578
        } elseif {${python.version} eq 311} {
            master_sites \
                    https://files.pythonhosted.org/packages/6d/69/9999c2d9e8a3b08dfcfc7e9259a05fb1da5f700936091d2eb4a7985c2776/
            checksums \
                    rmd160  b61bb20667b54049d28d820c18c1fcc808547505 \
                    sha256  ec06570d57bfa0e2be804405e3cdc2960e94887e7619ffb6bc053e9775b695aa \
                    size    259588062
        } elseif {${python.version} eq 310} {
            master_sites \
                    https://files.pythonhosted.org/packages/f0/da/f242771de50d12dc1816cc9a66dfa5b377e8cd6ea316a6ffc9a7d2c6dfb8/
            checksums \
                    rmd160  5855b7ed33bb270cc215352e09ce335d6a0d76dd \
                    sha256  546dc68d0740fb4b75593a6bfa308da9526fe31f65c2181d48c8551c4a0ad02f \
                    size    259544836
        } elseif {${python.version} eq 39} {
            master_sites \
                    https://files.pythonhosted.org/packages/a2/18/6382ea38225ea302d21368d735b7a10eae0996ae26fdf07945bd4927b893/
            checksums \
                    rmd160  da91191bed2ea052174ecf5db91d06cf19f454cc \
                    sha256  2528a162e879b40d81db3568c08256718cec4a0356580badbd362cd8af02a41b \
                    size    259545482
        }
    }

    depends_run-append \
                    port:py${python.version}-absl \
                    port:py${python.version}-astunparse \
                    port:py${python.version}-flatbuffers \
                    port:py${python.version}-gast \
                    port:py${python.version}-grpcio \
                    port:py${python.version}-h5py \
                    port:py${python.version}-keras \
                    port:py${python.version}-keras_preprocessing \
                    port:py${python.version}-ml_dtypes \
                    port:py${python.version}-numpy \
                    port:py${python.version}-opt_einsum \
                    port:py${python.version}-protobuf3 \
                    port:py${python.version}-tensorflow_estimator \
                    port:py${python.version}-scipy \
                    port:py${python.version}-tensorboard \
                    port:py${python.version}-termcolor \
                    port:py${python.version}-typing_extensions \
                    port:py${python.version}-wrapt \
                    port:py${python.version}-typeguard

    build           {}

    destroot.target ${distpath}/${distfiles}

    post-destroot {
        # avoid conflict with py${python.version}-tensorboard
        delete      ${destroot}${python.prefix}/bin/tensorboard \
                    ${destroot}${prefix}/bin/tensorboard-${python.branch}
    }

    livecheck.type  none
}
